/** @license Turbine.js | MIT License | https://github.com/wmbenedetto/turbine.js#mit-license */(function(e,t){var n=e.jQuery||null;typeof Function.prototype.bind!="function"&&(Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}});var i=function(t){if(typeof t!="object"||t===null){var n="Turbine constructor must be passed an initialization object";throw this.report({handle:"INIT_OBJ_NOT_DEFINED",desc:n}),new Error(n)}this.always={},this.alwaysWaitFor={},this.currentQuery=null,this.dirtyQueries={},this.globalTimeoutAllowed=!1,this.logLevel=t.logLevel||"ERROR",this.name=t.name||"Turbine",this.mixins={},this.numGlobalListeners=0,this.queries={},this.queryOrder=[],this.resets={},this.responses={},this.shortcuts={},this.started=!1,this.killed=!1,this.variables={},this.waitingFor=null,this.workflow={},this.timers={queries:{},delay:null,global:null},this.initPubSub(),this.importFunctions(t),this.importObjects(t),this.importAlways(),this.importMixins(),this.importWorkflow(t),typeof t.init=="function"&&t.init(this)};i.prototype={DEFAULT_GLOBAL_TIMEOUT:36e5,initPubSub:function(){var e=this;this.pubsub={publish:function(t,r){n(e).trigger(t,r)},listen:function(t,r){n(e).on(t,function(e){r(e.type,e.data)})},remove:function(t){n(e).unbind(t)}}},importFunctions:function(e){var t=null,r={},i=["init","log","publish","listen","remove","report"];for(var s=0;s<i.length;s++)t=i[s],typeof e[t]=="function"&&(this[t]=e[t],r[t]=!0);if(!n&&(!("publish"in r)||!("listen"in r)||!("remove"in r))){var o="["+this.name+".importFunctions()] You must either define publish(), listen(), and remove() functions via the initObj passed to the Turbine constructor, or you must include jQuery in the page.";throw this.report({handle:"REQUIRED_FUNCTIONS_NOT_DEFINED",desc:o}),new Error(o)}},importObjects:function(e){var t=null,n=["queries","resets","responses","shortcuts","variables","always","mixins"];for(var r=0;r<n.length;r++)t=n[r],this.utils.isObjLiteral(e[t])&&(this[t]=e[t])},importWorkflow:function(e){if(!this.utils.isObjLiteral(e.workflow)){var t="["+this.name+".importWorkflow()] Could not import workflow. Workflow must be an object literal.";throw this.report({handle:"COULD_NOT_IMPORT_WORKFLOW",desc:t}),new Error(t)}this.workflow=e.workflow||{},this.replaceMixins(this.workflow),this.utils.isObjLiteral(e.workflow)&&this.importQueries(e.workflow)},importAlways:function(){if(typeof this.always.waitFor!="undefined"){this.replaceShortcuts(this.always.waitFor),this.replaceVariables(this.always.waitFor);var e=this.parseWaitFor(this.always.waitFor);this.alwaysWaitFor=e.nextQueryObj,this.numAlwaysWaitFor=e.waitingFor.length}this.globalTimeoutAllowed=typeof this.always.timeout!="undefined"},importMixins:function(){for(var e in this.mixins)this.mixins.hasOwnProperty(e)&&this.replaceMixins(this.mixins[e])},importQueries:function(e){var t=0;for(var n in e)e.hasOwnProperty(n)&&(this.importQuery(n,e),t+=1);if(t===0){var r="["+this.name+".importQueries()] The workflow has no queries to import";throw this.report({handle:"NO_QUERIES_TO_IMPORT",desc:r}),new Error(r)}},importQuery:function(e,t){this.queries[e]=this.queries[e]||null,this.queryOrder.push(e),this.replaceMixins(e);for(var n in t[e])t[e].hasOwnProperty(n)&&this.importResponse(n,e,t)},importResponse:function(e,t,n){var r=n[t][e];r.repeat&&(r.repeat.counter=0),this.replaceShortcuts(r),this.replaceVariables(r)},log:function(e,t,n,i){},isLoggable:function(e){return!1},report:function(e){return null},publish:function(e,t,n){t=t||{},typeof e=="string"&&(e=[e]);for(var r=0;r<e.length;r++)this.pubsub.publish(e[r],t);typeof n=="function"&&n()},listen:function(e,t){typeof e=="string"&&(e=[e]);for(var n=0;n<e.length;n++)this.pubsub.listen(e[n],t)},remove:function(e){typeof e=="string"&&(e=[e]);for(var t=0;t<e.length;t++)this.pubsub.remove(e[t])},start:function(){if(this.isKilled())return null;this.started=!0,this.queue(null,this.getStartingQuery()),this.next()},stop:function(){this.started=!1,this.rewind()},kill:function(){this.started=!1,this.killed=!0,this.rewind()},next:function(){if(this.isKilled()||this.nextQuery===null)return null;this.exec(this.nextQuery)},exec:function(e){this.clearTimers(),this.isKillQuery(e)&&this.kill();if(this.isStopQuery(e))return this.stop(),null;if(this.isKilled())return null;this.currentQuery=e,this.nextQuery=null,this.responses[e]=this.getResponse(e);if(!this.utils.isObjLiteral(this.workflow[e]))return this.report({handle:"QUERY_DOES_NOT_EXIST",desc:"["+this.name+".exec()] "+e+" query does not exist"}),null;var t=this.responses[e],n=this.workflow[e][t];if(!n){t="default",n=this.workflow[e][t];if(!n)return this.report({handle:"RESPONSE_DOES_NOT_EXIST",desc:"["+this.name+".exec()] "+t+" response does not exist for the "+e+" query"}),null}n.responseName=t,this.processResponse(e,n)},processResponse:function(e,n,r){this.clearTimers();if(this.isKilled())return null;r||this.startGlobalTimeout(e,n);if(n.delay&&!n.isAfterDelay)this.startDelayTimeout(e,n);else{n.report&&!n.isPublishCallback&&this.reportIssueFromWorkflow(e,n),n.publish&&!n.waitFor&&!n.isPublishCallback&&this.publishNow(e,n);if(n.publish&&n.waitFor&&!n.isPublishCallback)this.publishAndWait(e,n);else{if(n.repeat){if(n.isAfterDelay)try{delete n.isAfterDelay}catch(i){n.isAfterDelay=t}this.repeat(e,n)}else n.waitFor?this.queue(n.waitFor,n.then):n.then&&(this.isEarlierQuery(n.then,this.currentQuery)&&this.rewind(this.currentQuery,n.then),this.exec(n.then));if(n.isPublishCallback)try{delete n.isPublishCallback}catch(i){n.isPublishCallback=t}n.timeout&&this.setResponseTimeout(e,n);if(n.isAfterDelay)try{delete n.isAfterDelay}catch(i){n.isAfterDelay=t}}}},reportIssueFromWorkflow:function(e,t){var n=this.responses[e];t.report=this.utils.isObjLiteral(t.report)?t.report:{},t.report.workflow={name:this.name,query:e,response:n,responseObj:this.workflow[e][n],timestamp:(new Date).getTime()},this.report(t.report)},setResponseTimeout:function(e,t){this.timers.queries[e]||(this.timers.queries[e]=[]);var n=this,r=setTimeout(function(){n.onResponseTimeout(e,t)},t.timeout.after);this.timers.queries[e].push(r)},repeat:function(e,t){t.repeat.counter+=1,t.repeat.limit===null?this.queue(t.waitFor,e):t.repeat.counter>=t.repeat.limit?this.processResponse(e,t.repeat):t.waitFor?(this.utils.isArray(t.waitFor)&&t.repeat.counter>1&&(t.waitFor=t.waitFor.slice(0,t.waitFor.length-this.numAlwaysWaitFor)),this.queue(t.waitFor,e)):this.exec(e)},rewind:function(e,t){this.clearTimers();var n=!1,r=this.queryOrder.length;e=e||this.queryOrder[r-1],t=t||this.queryOrder[0];for(var i=r;i>=0;i--){var s=this.queryOrder[i];s===e&&(n=!0),n&&this.clear(s);if(s===t)break}},isEarlierQuery:function(e,t){if(t===e)return!1;for(var n=0;n<this.queryOrder.length;n++){if(this.queryOrder[n]===e)return!0;if(this.queryOrder[n]===t)return!1}return!1},clear:function(e){this.clearQueryTimer(e);for(var t in this.workflow[e])this.workflow[e].hasOwnProperty(t)&&this.workflow[e][t].repeat&&(this.workflow[e][t].repeat.counter=0);this.resetResponse(e)},hasQueryFunction:function(e){return typeof this.queries[e]=="function"},resetResponse:function(e){if(this.isDirtyQuery(e))this.dirtyQueries[e]=null;else{var t=!1;typeof this.resets[e]=="function"?(this.responses[e]=this.resets[e](),t=!0):typeof this.resets[e]!="undefined"&&(this.responses[e]=this.resets[e],t=!0)}},onResponseTimeout:function(e,t){this.waitingFor&&this.remove(this.waitingFor),t.timeout.isAfterTimeout=!0,this.processResponse(e,t.timeout,!0)},publishNow:function(e,t){var n=null,r={};this.utils.isObjLiteral(t.publish)?(n=t.publish.message,r=this.getUsingObject(t.publish.using)):n=t.publish,this.publish(n,r)},publishAndWait:function(e,t){var n=this,r=null,i={};this.utils.isObjLiteral(t.publish)?(r=t.publish.message,i=this.getUsingObject(t.publish.using)):r=t.publish,i.counter=typeof t.repeat!="undefined"?t.repeat.counter:0;var s=function(){t.isPublishCallback=!0,n.processResponse(e,t)};this.publish(r,i,s)},getUsingObject:function(e){return e=typeof e=="undefined"?{}:e,this.always.using&&(e=this.utils.mergeObjects(e,this.always.using)),e},startDelayTimeout:function(e,t){var n=this;this.timers.delay=setTimeout(function(){n.onDelayTimeout(e,t)},t.delay.for)},onDelayTimeout:function(e,t){this.processResponse(e,t.delay)},getStartingQuery:function(){var e=this.getShortcut("start");return e?e:this.queryOrder[0]},queue:function(e,t){this.waitingFor&&this.remove(this.waitingFor);var n=this.parseWaitFor(e,t,!0);this.waitingFor=n.waitingFor,this.nextQueryObj=n.nextQueryObj,this.nextQuery=t,this.waitingFor.length>0&&this.listen(this.waitingFor,this.handleIncomingMessage.bind(this))},parseWaitFor:function(e,t,n){var r=[],i={};if(e)if(typeof e=="string")r.push(e),i[e]=t;else{this.utils.isObjLiteral(e)&&(e=[e]);for(var s=0;s<e.length;s++)if(typeof e[s]=="string")r.push(e[s]),i[e[s]]=t;else if(typeof e[s].message!="undefined")if(this.utils.isArray(e[s].message))for(var o=0;o<e[s].message.length;o++)r.push(e[s].message[o]),i[e[s].message[o]]=e[s].then||t;else r.push(e[s].message),i[e[s].message]=e[s].then||t}if(n)for(var u in this.alwaysWaitFor)this.alwaysWaitFor.hasOwnProperty(u)&&(r.push(u),i[u]=this.alwaysWaitFor[u]||t);return{waitingFor:r,nextQueryObj:i}},handleIncomingMessage:function(e,t){return this.isKilled()?null:(this.waitingFor&&(this.remove(this.waitingFor),this.nextQuery=this.getNextQuery(e)),this.waitingFor=null,this.isEarlierQuery(this.nextQuery,this.currentQuery)&&this.rewind(this.currentQuery,this.nextQuery),this.isKilled()||this.next(),!0)},getNextQuery:function(e){var t=null;for(var n in this.nextQueryObj)if(this.nextQueryObj.hasOwnProperty(n)&&e===n){t=this.nextQueryObj[n];break}return t},clearTimers:function(){this.clearAllQueryTimers(),this.clearGlobalTimer(),this.clearDelayTimer()},clearAllQueryTimers:function(){for(var e in this.timers.queries)this.timers.queries.hasOwnProperty(e)&&this.clearQueryTimer(e)},clearQueryTimer:function(e){var n=this.timers.queries[e];if(n){for(var r=0;r<n.length;r++)clearTimeout(n[r]);try{delete this.timers.queries[e]}catch(i){this.timers.queries[e]=t}}},clearGlobalTimer:function(){this.timers.global!==null&&(clearTimeout(this.timers.global),this.timers.global=null)},clearDelayTimer:function(){this.timers.delay!==null&&(clearTimeout(this.timers.delay),this.timers.delay=null)},startGlobalTimeout:function(e,t){if(!this.isGlobalTimeoutAllowed())return!1;this.clearGlobalTimer();var n=this.getGlobalTimeout(),r=this;return this.timers.global=setTimeout(function(){r.onGlobalTimeout(e,t)},n),!0},getGlobalTimeout:function(){return this.utils.isObjLiteral(this.always.timeout)&&typeof this.always.timeout.after!="undefined"?this.always.timeout.after:this.DEFAULT_GLOBAL_TIMEOUT},onGlobalTimeout:function(e,t){this.waitingFor&&this.remove(this.waitingFor),this.always.timeout.isAfterTimeout=!0,this.processResponse(null,this.always.timeout,!0)},isGlobalTimeoutAllowed:function(){return this.globalTimeoutAllowed===!0},isKilled:function(){return this.killed===!0},isStopped:function(){return this.started!==!0},isStarted:function(){return this.started===!0},isStopQuery:function(e){return e==="stop."},isKillQuery:function(e){return e==="kill!"},isDirtyQuery:function(e){return this.dirtyQueries[e]===!0},setResponse:function(e,t){this.responses[e]=t,this.dirtyQueries[e]=!0},getResponse:function(e){this.responses[e]=this.hasQueryFunction(e)?this.queries[e]():this.responses[e];if(typeof this.responses[e]=="boolean"||this.responses[e]===null||typeof this.responses[e]=="undefined")this.responses[e]=this.responses[e]?"yes":"no";return this.responses[e]},getVar:function(e){return e=e.indexOf("$")===0?e.substr(1):e,typeof this.variables[e]!="undefined"?this.variables[e]:null},getShortcut:function(e){return e=e.indexOf("@")!==0?"@"+e:e,this.shortcuts[e]||null},replaceVariables:function(e){var t,n,r;for(var i in this.variables)if(this.variables.hasOwnProperty(i))for(var s in e)e.hasOwnProperty(s)&&(t=e[s],n="$"+i,r=this.variables[i],typeof t=="string"&&t.indexOf(n)>-1?e[s]=t.replace(new RegExp("\\"+n,"g"),r):this.utils.isObjLiteral(t)&&this.replaceVariables(t))},replaceShortcuts:function(e){this.replace(e,this.shortcuts,"@",!0,"shortcut")},replaceMixins:function(e){this.replace(e,this.mixins,"+",!0,"mixin")},replace:function(e,t,n,r,i){for(var s in e)if(e.hasOwnProperty(s)){var o=e[s];typeof o=="string"&&o.indexOf(n)===0?(o=o.substr(1),t[o]&&(e[s]=t[o])):r&&typeof o=="object"&&this.replace(o,t,n,r,i)}},utils:{isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},inArray:function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1},isObjLiteral:function(e){return typeof e=="object"&&e!==null&&!this.isArray(e)},mergeObjects:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(typeof e[n]=="object"&&e[n]!==null&&typeof t[n]=="object"&&t[n]!==null?e[n]=this.mergeObjects(e[n],t[n]):e[n]=t[n]);return e}}},typeof define=="function"?define(function(){return i}):e.Turbine=i})(this);